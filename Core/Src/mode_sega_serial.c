/*
 * mode_sega_serial.c
 *
 *  Created on: Jun 27, 2025
 *      Author: Qinh
 */
#include "mode_sega_serial.h"
#include "Card_Reader.h"
#include "utils.h"
#include "mcc.h"

#define N_TABLES 8
#define ITER_ADD 0x05

packet_request_t req;
packet_response_t res;

uint8_t len, r, checksum;

uint8_t *sega_write_buffer = Card.operation_tmp;;
uint8_t sega_current_mifare_key_a[6];
uint8_t sega_current_mifare_key_b[6];
uint8_t sega_systemcode[2] = {0x88,0xb4};

//uint8_t sega_access_aime[4] = {0x70,0xf8,0x78,0x11};
extern uint8_t auth_flag;

uint8_t sega_packet_check(uint8_t* data,uint8_t len) {
	bool escape = false;
	uint8_t raw_pos = 0;
	uint8_t req_pos = 1;
	uint8_t checksum = 0;
	while(raw_pos<len){
		if(data[raw_pos] == SERIAL_CMD_START){
			req.frame_len = data[++raw_pos];
			checksum += req.frame_len;
			raw_pos++;
			break;
		}
		raw_pos++;
	}
	if(raw_pos == len){
		return 0;
	}
	while(req_pos != req.frame_len){
		if (data[raw_pos] == 0xD0) {
			escape = true;
			raw_pos++;
		}else if (escape) {
			req.bytes[req_pos] = data[raw_pos] + 1;
			checksum += req.bytes[req_pos];
			escape = false;
			raw_pos++;
			req_pos++;
		}else{
			req.bytes[req_pos] = data[raw_pos];
			checksum += req.bytes[req_pos];
			raw_pos++;
			req_pos++;
		}
		if(raw_pos == len){
			return 0;
		}
	}
	req.bytes[req_pos] = data[raw_pos];
	if (req.cmd == CMD_SEND_BINDATA_EXEC){
		return CMD_SEND_BINDATA_EXEC;
	}else if(checksum == req.bytes[req.frame_len]){
		return req.cmd;
	}else{
		return STATUS_SUM_ERROR;
	}
}

void sega_packet_write() {
  uint8_t checksum = 0, len = 0;
  if (res.cmd == 0) {
    return;
  }
  memset(sega_write_buffer,0,128);
  sega_write_buffer[0] = 0xE0;
  uint8_t current_pos = 0;
  while (len <= res.frame_len) {
    uint8_t w;
    if (len == res.frame_len) {
      w = checksum;
    } else {
      w = res.bytes[len];
      checksum += w;
    }
    if (w == 0xE0 || w == 0xD0) {
    	sega_write_buffer[++current_pos] = 0xD0;
    	sega_write_buffer[++current_pos] = --w;
    } else {
    	sega_write_buffer[++current_pos] = w;
    }
    len++;
  }
  res.cmd = 0;
  Interface_Send(sega_write_buffer ,++current_pos);
}

void res_clear(uint8_t payload_len) {
  res.frame_len = 6 + payload_len;
  res.addr = req.addr;
  res.seq_no = req.seq_no;
  res.cmd = req.cmd;
  res.status = STATUS_OK;
  res.payload_len = payload_len;
}

void sys_to_normal_mode() {
	res_clear(0);
	res.seq_no = 0;
}

void sys_get_fw_version() {
	if(Flash.sega_setting & 1){
		const char fw_version[24] = "TN32MSEC003S F/W Ver1.2";
		res_clear(sizeof(fw_version) - 1);
		memcpy(res.version, fw_version, res.payload_len);
	}
	else{
		const char fw_version[2] = "\x94";
		//char fw_version[2] = "\x92";
		res_clear(sizeof(fw_version) - 1);
		memcpy(res.version, fw_version, res.payload_len);
	}
}

void sys_get_hw_version() {
	if(Flash.sega_setting & 1){
		const char hw_version[24] = "TN32MSEC003S H/W Ver3.0";
		res_clear(sizeof(hw_version) - 1);
		memcpy(res.version, hw_version, res.payload_len);
	}
	else{
		const char hw_version[10] = "837-15396";
		//char hw_version[10] = "837-15286";
		res_clear(sizeof(hw_version) - 1);
		memcpy(res.version, hw_version, res.payload_len);
	}
}

void sys_get_led_info() {
	if(Flash.sega_setting & 1){
		const char led_info[10] = "15084\xFF\x10\x00\x12";
		res_clear(sizeof(led_info) - 1);
		memcpy(res.version, led_info, res.payload_len);
	}
	else{
		const char led_info[13] = "000-00000\xFF\x11\x40";
		res_clear(sizeof(led_info) - 1);
		memcpy(res.version, led_info, res.payload_len);
	}
}


void nfc_start_polling() {
  res_clear(0);
}

void nfc_stop_polling() {
  res_clear(0);
}

void nfc_card_detect() {
	if(Card.operation != Operation_idle){
		switch(Card.type){
			case Card_None:
				break;
			case Card_Type_Mifare_Classic:
				if(Card.mifare_auth_status == 0){
					//pre-read still going...
					break;
				}
				memcpy(res.mifare_uid,Card.iso14443_uid4,4);
			    res_clear(0x07);
			    res.id_len = 4;
			    res.count = 1;
			    res.type = 0x10;
			    return;
			case Card_Type_Mifare_UltraLight:
				if(Flash.sega_setting && SYSTEM_NESICA_SUPPORT){
					memcpy(res.mifare_uid,Card.iso14443_uid7,4);
				    res_clear(0x07);
				    res.id_len = 4;
				    res.count = 1;
				    res.type = 0x10;
				}
				return;
			case Card_Type_Felica_AIC:
				memcpy(res.IDm, Card.felica_IDm,8);
				memcpy(res.PMm, Card.felica_PMm,8);
		        res_clear(0x13);
		        res.count = 1;
		        res.type = 0x20;
		        res.id_len = 0x10;
		        return;
			case Card_Type_ISO15693:
				if(Flash.sega_setting && SYSTEM_EPASS_SUPPORT){
					memcpy(res.mifare_uid,Card.iso15693_uid,4);
				    res_clear(0x07);
				    res.id_len = 4;
				    res.count = 1;
				    res.type = 0x10;
				}
				return;
			case Card_Type_ISO14443A_T_Union:
				if(Flash.sega_setting && SYSTEM_TUNION_SUPPORT){
					memcpy(res.mifare_uid,Card.t_union_uid,4);
					res_clear(0x07);
					res.id_len = 4;
					res.count = 1;
					res.type = 0x10;
				}
				return;
			case Card_Type_ISO14443A_Unknow:
				break;
		}
	}
	res_clear(1);
	res.count = 0;
}

void nfc_mifare_authorize_a() {
	res_clear(0);
	if((Card.type == Card_Type_Mifare_UltraLight) && (Flash.sega_setting && SYSTEM_NESICA_SUPPORT) && !memcmp(sega_current_mifare_key_a,AimeKey,6)){
		return;
	}
	if((Card.type == Card_Type_ISO14443A_T_Union) && (Flash.sega_setting && SYSTEM_TUNION_SUPPORT) && !memcmp(sega_current_mifare_key_a,AimeKey,6)){
		return;
	}
	if((Card.type == Card_Type_ISO15693) && (Flash.sega_setting && SYSTEM_EPASS_SUPPORT) && !memcmp(sega_current_mifare_key_a,AimeKey,6)){
		return;
	}
	if((Card.type != Card_Type_Mifare_Classic) || !(Card.mifare_auth_status & Auth_KeyA_Right)){
		res.status = STATUS_CARD_ERROR;
		return;
	}
//	if(mifareAuthenticate(MCC_AUTH_KEY_A, 0, Card.iso14443_uid4, 4, sega_mifare_key_a) != RFAL_ERR_NONE){
	if(memcmp(sega_current_mifare_key_a,Card.mifare_right_key_a,6)){
		res.status = STATUS_CARD_ERROR;
	}
}

void nfc_mifare_authorize_b() {
	res_clear(0);
	if((Card.type == Card_Type_Mifare_UltraLight) && (Flash.sega_setting && SYSTEM_NESICA_SUPPORT) && !memcmp(sega_current_mifare_key_b,AimeKey,6)){
		return;
	}
	if((Card.type == Card_Type_ISO14443A_T_Union) && (Flash.sega_setting && SYSTEM_TUNION_SUPPORT) && !memcmp(sega_current_mifare_key_b,AimeKey,6)){
		return;
	}
	if((Card.type == Card_Type_ISO15693) && (Flash.sega_setting && SYSTEM_EPASS_SUPPORT) && !memcmp(sega_current_mifare_key_b,AimeKey,6)){
		return;
	}
	if((Card.type != Card_Type_Mifare_Classic) || !(Card.mifare_auth_status & Auth_KeyB_Right)){
		res.status = STATUS_CARD_ERROR;
		return;
	}
//	if(mifareAuthenticate(MCC_AUTH_KEY_B, 0, Card.iso14443_uid4, 4, sega_mifare_key_b) != RFAL_ERR_NONE){
	if(memcmp(sega_current_mifare_key_b,Card.mifare_right_key_b,6)){
		res.status = STATUS_CARD_ERROR;
	}
}

void nfc_mifare_read() {
	res_clear(0x10);
	if((Card.type == Card_Type_Mifare_UltraLight) && (Flash.sega_setting && SYSTEM_NESICA_SUPPORT)){
		if(req.block_no == 0){
			memcpy(res.block,Card.iso14443_uid7,4);
		}
		else if(req.block_no == 2){
			ascii_to_accesscode(Card.nesica_serial ,res.block + 6);
		}else{
			memset(res.block, 0, 16);
		}
	}else if((Card.type == Card_Type_ISO14443A_T_Union) && (Flash.sega_setting && SYSTEM_TUNION_SUPPORT)){
		if(req.block_no == 0){
			memcpy(res.block,Card.t_union_uid,4);
		}
		else if(req.block_no == 2){
			memcpy(res.block + 6,Card.t_union_serial,10);
		}else{
			memset(res.block, 0, 16);
		}
	}else if((Card.type == Card_Type_ISO15693) && (Flash.sega_setting && SYSTEM_EPASS_SUPPORT)){
		if(req.block_no == 0){
			memcpy(res.block,Card.iso15693_uid,4);
		}
		if(req.block_no == 2){
			//memcpy(res.block + 13,Card.iso14443_uid7,7);
			hex_to_accesscode(Card.iso15693_uid ,res.block+6);
		}
	}else if((Card.type != Card_Type_Mifare_Classic)){
	  res.status = STATUS_CARD_ERROR;
	  return;
	}else{
		memcpy(res.block,Card.mifare_data[req.block_no],16);
	}
//	if(mifareReadBlock(0, req.block_no, res.block, 16) != RFAL_ERR_NONE){
//		res_clear(0);
//		res.status = STATUS_CARD_ERROR;
//	}
}

void nfc_felica_through() {
	if((Card.operation != Operation_busy) && (Card.type != Card_Type_Felica_AIC)){
		res_clear(0);
		res.status = STATUS_CARD_ERROR;
		return;
	}
	uint8_t code = req.encap_code;
	res.encap_code = code + 1;
	switch (code) {
		case FelicaPolling:
		{
			res_clear(0x14);
			memcpy(res.poll_systemCode,sega_systemcode,2);
		}
		break;
		case FelicaReqSysCode:
		{
			res_clear(0x0D);
			res.felica_payload[0] = 0x01;
			memcpy(&res.felica_payload[1],sega_systemcode,2);
		}
		break;
		case FelicaActive2:
		{
			res_clear(0x0B);
			res.felica_payload[0] = 0x00;
		}
		break;
		case FelicaReadWithoutEncryptData:
		{
//			uint16_t serviceCodeList = req.serviceCodeList[1] << 8 | req.serviceCodeList[0];
//			uint16_t serviceCodeList = 0x000b;
//			uint8_t blockList[4];
//			for (uint8_t i = 0; i < req.numBlock; i++) {
//			  blockList[i] = req.blockList[i][1];
//			}

//			if(nfcfReadBlock(Card.felica_IDm, &serviceCodeList , 1, blockList, res.blockData) != RFAL_ERR_NONE){
//				//LED_show(0,255,255);
//				res.status = STATUS_CARD_ERROR;
//			}


			if((req.blockList[0][0] == 0x80) && (req.blockList[0][1] == 0x82)){
				memcpy(res.blockData[0],Card.felica_IDm,8);
			}
			res.RW_status[0] = 0;
			res.RW_status[1] = 0;
			res.numBlock = req.numBlock;
			res_clear(0x0D + req.numBlock * 16);
		}
		break;
		case FelicaWriteWithoutEncryptData:
		{
//			int8_t result = 0;
//			uint16_t serviceCodeList = req.serviceCodeList[1] << 8 | req.serviceCodeList[0];
//			uint16_t blockList = (uint16_t)(req.blockList_write[0][0] << 8 | req.blockList_write[0][1]);
//			if(nfcfWriteSingleBlock(Card.felica_IDm, 1, &serviceCodeList , &blockList, req.blockData) != RFAL_ERR_NONE){
//				LED_show(255,255,0);
//				res.status = STATUS_CARD_ERROR;
//			}else{
				res_clear(0x0C);
				res.RW_status[0] = 0;
				res.RW_status[1] = 0;
//			}
		}
		break;
		default:
			res_clear(0);
			res.status = STATUS_INVALID_COMMAND;
  }
  res.encap_len = res.payload_len;
}

void Sega_Mode_Loop(uint8_t cmd){
  switch (cmd) {
      case 0:
        break;
      case CMD_TO_NORMAL_MODE:
        sys_to_normal_mode();
        break;
      case CMD_TO_UPDATER_MODE:
        res_clear(0);
        res.status = STATUS_OK;
        break;
      case CMD_SEND_BINDATA_EXEC:
        res_clear(0);
        res.status = STATUS_FIRM_UPDATE_SUCCESS;
      case CMD_GET_FW_VERSION:
        sys_get_fw_version();
        break;
      case CMD_GET_HW_VERSION:
        sys_get_hw_version();
        break;
      case CMD_SEND_HEX_DATA:
        res_clear(0);
        res.status = STATUS_COMP_DUMMY_3RD;
        break;

    // Card read
      case CMD_START_POLLING:
    	Card.operation = Operation_idle;
        nfc_start_polling();
        break;
      case CMD_STOP_POLLING:
        nfc_stop_polling();
        break;
      case CMD_CARD_DETECT:
        nfc_card_detect();
        break;

    // MIFARE
      case CMD_MIFARE_KEY_SET_A:
        memcpy(sega_current_mifare_key_a, req.key, 6);
        res_clear(0);
        break;

      case CMD_MIFARE_KEY_SET_B:
        memcpy(sega_current_mifare_key_b, req.key, 6);
        res_clear(0);
        break;

      case CMD_MIFARE_AUTHORIZE_A:
        nfc_mifare_authorize_a();
        break;

      case CMD_MIFARE_AUTHORIZE_B:
        nfc_mifare_authorize_b();
        break;

      case CMD_MIFARE_READ:
        nfc_mifare_read();
        break;

    // FeliCa
      case CMD_FELICA_THROUGH:
        nfc_felica_through();
        break;

    // LED
      case CMD_EXT_BOARD_LED_RGB:
        LED_show(req.color_payload[0] , req.color_payload[1] , req.color_payload[2]);
    	  res_clear(0);
        break;

      case CMD_EXT_BOARD_INFO:
        sys_get_led_info();
        break;

      case CMD_EXT_BOARD_LED_RGB_UNKNOWN:
    	  res_clear(0);
        break;

      case CMD_CARD_SELECT:
          res_clear(0);
          break;
      case CMD_CARD_HALT:
          res_clear(0);
          break;
      case CMD_EXT_TO_NORMAL_MODE:
        res_clear(0);
        break;

      case STATUS_SUM_ERROR:
        res_clear(0);
        res.status = STATUS_SUM_ERROR;
        break;

//      case CMD_READ_EEPROM:
//        res_init();
//        res.payload_len = 4;
//        res.frame_len = 10;
//       for(uint8_t i = 0;i<3;i++){
//          res.eeprom_data[i] = system_setting[i];
//        }
//        res.board_vision = BOARD_VISION;
//        break;
//
//     case CMD_WRITE_EEPROM:
//        system_setting[0] = req.eeprom_data[0];
//        system_setting[1] = req.eeprom_data[1];
//        for(uint8_t i = 0;i<8;i++)
//        {
//          mapped_card_IDm[i] = req.mapped_IDm[i];
//        }
//        for(uint8_t i = 0;i<10;i++)
//        {
//          card_reflect.block2[i+6] = req.target_accesscode[i];
//        }
//        EEPROM.write(0, system_setting[0]);
//        EEPROM.write(1, system_setting[1]);
//        for(uint8_t j = 0;j<8;j++)
//        {
//          EEPROM.write(j+4, req.mapped_IDm[j]);
//        }
//        for(uint8_t k = 0;k<10;k++)
//        {
//          EEPROM.write(k+12, req.target_accesscode[k]);
//        }
//        SerialDevice.begin((system_setting[0] & 0b10)? 115200 : 38400);
//        if (system_setting[0] & 0b10){
//         LED_show(0,0,255);
//         }
//        else{
//          LED_show(0,255,0);
//        }
//        delay(1);
//        res_init();
//        break;

      default:
        res_clear(0);
        res.status = STATUS_OK;
        break;
  }
  sega_packet_write();
}

const uint8_t S_BOX_INV[9][256] = {
{0x24,0x3C,0xBA,0x36,0xE3,0x85,0xA4,0xD0,0x93,0x43,0x73,0xB9,0x70,0x6E,0xC9,0xF1,0x10,0x0E,0x9B,0x2C,0x97,0xE7,0x0B,0x63,0x6C,0x29,0x20,0xFE,0x86,0xF3,0xE1,0xF5,0xF6,0x9F,0xB6,0x16,0x04,0x7B,0x8F,0xAB,0xB1,0x39,0x2A,0x1B,0xEB,0x5C,0xA8,0xAC,0x38,0x11,0x12,0x5F,0x89,0x3E,0x7D,0xCA,0xEC,0x53,0xDB,0x6D,0x1E,0xD2,0x81,0x78,0x96,0x46,0xFF,0xF9,0x54,0x1C,0x28,0x7A,0x4F,0xD3,0xC0,0xDC,0xC1,0x6A,0xF2,0xBC,0xCB,0x57,0xFD,0x4A,0xE4,0xF0,0xB2,0xC7,0x95,0x40,0x62,0x52,0x41,0xE2,0xAD,0x49,0xA6,0xB5,0x1F,0x02,0xC8,0xDA,0x92,0xE5,0xB0,0xC5,0x64,0x76,0x48,0x21,0xDE,0x0F,0x45,0x58,0x4C,0xDF,0xA7,0x84,0xCF,0xD5,0x15,0x4E,0x27,0x80,0x6B,0x7F,0xFC,0x44,0x71,0x47,0x22,0xDD,0x30,0x0C,0xA1,0x3B,0xE0,0x37,0xA0,0x35,0x23,0x90,0x32,0x74,0xBF,0x8D,0xC2,0xEA,0xD6,0x50,0xBB,0xD9,0xC4,0x83,0xB4,0x31,0x68,0x55,0x8B,0x5D,0xF4,0x72,0x18,0xB7,0xEF,0xF7,0x98,0x2D,0x01,0x03,0x61,0xCC,0x0A,0x8E,0x13,0x00,0xE8,0x14,0xAF,0x09,0x51,0x75,0xA5,0x2F,0x1D,0x0D,0x65,0x8A,0xCD,0x66,0x07,0x3D,0x05,0xD8,0x4B,0xE9,0x9D,0x99,0x7C,0x91,0xD1,0xB8,0x19,0xC3,0x2B,0x42,0x69,0x88,0xC6,0x79,0x17,0x3A,0x4D,0x5B,0xA2,0x5A,0xFB,0x25,0x3F,0xBD,0xF8,0xED,0xCE,0xE6,0x87,0xA3,0x26,0xA9,0x2E,0xBE,0x94,0x08,0x7E,0x67,0x60,0x8C,0x9C,0x5E,0x6F,0xB3,0x9E,0x06,0xFA,0x82,0xAE,0xEE,0x59,0x77,0xD7,0x1A,0x9A,0x34,0xD4,0x56,0xAA,0x33,},
{0xF9,0x81,0x7C,0x00,0xB9,0x30,0x37,0xD5,0x90,0x51,0x6E,0xF0,0xB2,0x06,0xFB,0xCD,0x39,0x14,0x5F,0xF8,0x1B,0xC7,0x4A,0x82,0x70,0x8C,0x92,0x1D,0xEA,0xC3,0x4E,0xC8,0x12,0xE6,0xB6,0x10,0xD3,0x2F,0x95,0x84,0x25,0x42,0xA5,0x72,0xE5,0x8F,0x55,0xEF,0x86,0xA2,0x53,0xAE,0xED,0x26,0x20,0x47,0xDE,0x78,0x68,0x28,0xE4,0x45,0xCC,0x35,0xBC,0x3E,0xBB,0x8E,0xC0,0xBE,0x34,0xAF,0xA6,0x09,0x64,0x01,0x7B,0x44,0xF5,0xF3,0xB1,0x3F,0xA4,0xB3,0x32,0x80,0xC9,0x4F,0x6F,0x40,0xBF,0x21,0x4C,0x74,0xE1,0x11,0x5E,0xEB,0x3D,0x71,0x2E,0x9D,0x62,0x75,0xD4,0x16,0x48,0x77,0x13,0x67,0xAD,0x6B,0x5D,0x07,0x87,0xF7,0xA8,0x9A,0x59,0x76,0x8B,0x9B,0x1E,0xD8,0xEE,0xAA,0xE9,0x99,0x2D,0xC5,0x97,0xF1,0xA7,0x83,0xFC,0xCA,0xDC,0xBA,0xB8,0x4B,0xE8,0x89,0x17,0x05,0x0B,0xA0,0x65,0x23,0xD1,0xCE,0x36,0x03,0xD7,0xE0,0xF2,0x91,0xDF,0x0E,0x9C,0x2C,0x0D,0x66,0xD6,0x73,0x58,0x5C,0xB4,0x0A,0x4D,0xC2,0x3B,0xD2,0xB7,0xE2,0xAC,0x33,0xDB,0x60,0x27,0xBD,0x56,0x43,0x24,0x04,0x02,0x8D,0x7D,0x7F,0xF6,0xB5,0xF4,0xFD,0xDD,0x5B,0xEC,0x79,0xC4,0x22,0x1F,0xA1,0x88,0x54,0xE7,0x19,0x98,0x94,0x7E,0x31,0xA3,0x29,0xE3,0x5A,0xCB,0x6A,0xB0,0xCF,0x6D,0x93,0x6C,0x7A,0x08,0xA9,0x3C,0x1C,0xD0,0x63,0x50,0xC6,0x85,0x38,0xC1,0x41,0x49,0xAB,0x61,0x52,0x2A,0x9F,0xD9,0x18,0x1A,0x57,0x46,0x2B,0x69,0xDA,0xFA,0xFF,0x0F,0x15,0x96,0x3A,0x8A,0xFE,0x9E,0x0C,},
{0x11,0xA2,0x9A,0xC3,0x94,0xA0,0x51,0x01,0x5B,0xF7,0xD1,0x30,0xEE,0x1F,0x06,0xD5,0x77,0x67,0xD3,0xC1,0x6E,0xE7,0x6A,0x1A,0xA4,0x8E,0x9F,0x65,0x66,0xD6,0x0C,0x2D,0xC6,0xE4,0x69,0xB7,0x56,0x5A,0x57,0x60,0xFC,0x79,0x1E,0xE1,0x16,0x52,0xF0,0x07,0xD0,0xCD,0xCA,0x78,0xC9,0x8B,0xB3,0x88,0x27,0xF6,0xE0,0xC0,0x84,0xCF,0x2F,0xA3,0x04,0x00,0x80,0x40,0xA7,0xFA,0x75,0x9D,0x4B,0x89,0x46,0x22,0x28,0x37,0x34,0x13,0xFF,0x20,0xB4,0xDA,0x08,0x26,0x6C,0x8F,0xF2,0x5D,0x7B,0x73,0x5C,0x4C,0x90,0x71,0x41,0x8A,0x9E,0xBB,0x12,0xE8,0x55,0x6D,0x2A,0x25,0x4A,0xAF,0xBD,0x95,0x19,0xA5,0x31,0xBA,0xAD,0xD9,0xC5,0xA6,0x6B,0x83,0xC4,0xB6,0xA9,0xCC,0xF9,0xA1,0xB1,0x7A,0xDC,0xC7,0xDB,0x2E,0x7E,0x7F,0x8D,0x4E,0x62,0x0F,0x03,0x39,0xFD,0xB8,0xD4,0x18,0xC2,0xEC,0x61,0x02,0x53,0x1C,0x3B,0x7D,0xBC,0x1D,0x59,0xF5,0x8C,0x98,0xF1,0x6F,0x93,0x85,0xF8,0x2C,0x74,0xD8,0x5E,0x4D,0x97,0xAB,0x87,0x82,0x0A,0x21,0x42,0x5F,0x0D,0x58,0x33,0x44,0x3A,0xDD,0xE9,0xFB,0x50,0x47,0xC8,0xD7,0x81,0x9B,0xE5,0x1B,0x17,0x54,0x86,0x2B,0xEF,0xF4,0x29,0x32,0x0E,0x7C,0x23,0x15,0xEB,0xE6,0x3C,0x35,0xE2,0x96,0x68,0x3F,0x0B,0x43,0xCE,0xDE,0x9C,0xBE,0x4F,0x45,0x72,0x76,0xB5,0x10,0xE3,0xDF,0x92,0xD2,0xA8,0x48,0x91,0xB9,0xAC,0xBF,0x49,0xB2,0x99,0x64,0x70,0xEA,0xF3,0x3E,0x63,0x14,0xAE,0xED,0xAA,0x24,0xFE,0x3D,0xCB,0xB0,0x09,0x38,0x36,0x05,},
{0xC4,0xF0,0x28,0x49,0x55,0x4A,0xF5,0xFD,0x75,0xAF,0x20,0x69,0xC8,0x43,0x86,0x6B,0xC9,0xA8,0xC6,0x54,0x4C,0xDD,0x02,0x5B,0xE8,0x9B,0x59,0x77,0x34,0xD7,0xC0,0x51,0x5F,0xF3,0x7E,0xD4,0xF1,0x90,0x81,0xCE,0x19,0x8A,0x78,0x33,0xCD,0x97,0x8C,0xD6,0x6A,0x4B,0x8F,0xA4,0x80,0xDC,0x1A,0x17,0x14,0xC5,0x07,0x87,0x66,0xAD,0x9D,0x85,0xB2,0xF8,0x8D,0x98,0xDF,0x3E,0x1F,0x3F,0x64,0x58,0x40,0xAC,0x6C,0x5C,0x08,0x5D,0x53,0xBA,0xFF,0xD2,0xA9,0x2C,0x25,0xAB,0xE4,0x32,0x38,0x9A,0xF9,0xCB,0xC2,0x91,0x67,0xD0,0xE3,0x22,0x29,0x2D,0x92,0x48,0xB4,0x0E,0x99,0x05,0xA3,0x6F,0x0A,0x15,0xEF,0xD5,0x10,0x4F,0xD8,0xF6,0x00,0xE6,0x46,0x2B,0x31,0x57,0x83,0x94,0xAE,0x03,0xEB,0x8E,0x13,0x24,0xA1,0x1E,0x5E,0xD1,0x26,0xD9,0xA7,0xCA,0x36,0x6E,0x71,0x37,0xEE,0xB1,0xFA,0x7C,0x76,0x06,0xB8,0x23,0xBE,0x21,0xBC,0x9E,0xC1,0xDA,0x7A,0x3B,0x62,0x27,0x7B,0xB0,0xE5,0x63,0x18,0x82,0x7F,0x0F,0xED,0xA0,0x2A,0x9C,0xBF,0x11,0xBD,0xE0,0x88,0x0D,0x3A,0x79,0x52,0x56,0xF7,0xB6,0xD3,0x09,0x16,0x1B,0x70,0xB3,0x42,0x60,0x2F,0x1C,0xA2,0x9F,0x72,0x12,0x45,0x47,0xBB,0xE1,0x0B,0x01,0x8B,0x1D,0xDE,0xEC,0x0C,0x4E,0xE9,0xCF,0xCC,0x95,0x74,0xF4,0xA5,0x93,0xC7,0xDB,0x4D,0xFB,0x35,0x65,0xFE,0xE7,0x39,0xB5,0xEA,0x96,0xC3,0x04,0x41,0x44,0x84,0xFC,0x6D,0x30,0xE2,0xF2,0x68,0xB7,0x89,0x7D,0x73,0x3D,0xB9,0x5A,0x50,0xA6,0x3C,0x61,0xAA,0x2E,},
{0x1A,0x59,0x9C,0xAD,0xC8,0xE4,0x11,0x54,0xED,0x37,0x0F,0x3A,0xE6,0x5F,0x3C,0x4B,0xB8,0x15,0x89,0xB1,0xE8,0xDA,0x69,0x77,0x91,0x56,0x8B,0xDB,0x06,0x24,0xCF,0x18,0xF8,0xB0,0x87,0xDF,0x8C,0x35,0xCB,0x86,0x53,0x9D,0xA4,0x66,0x4A,0x7A,0x71,0x0A,0x48,0x38,0xFF,0xDC,0x83,0x20,0xCE,0x98,0x32,0xF6,0xD7,0xAF,0x70,0x5E,0x73,0x8A,0x14,0x72,0x1E,0xC1,0x29,0x79,0x07,0x08,0xE9,0x43,0x46,0xD0,0x2F,0xDE,0x2A,0x4F,0x3D,0x2C,0x50,0xB3,0x75,0xFC,0x0B,0x64,0xAE,0x31,0x7B,0x61,0xA5,0x30,0xA0,0x93,0xD2,0xBE,0xC2,0x55,0xBA,0x6C,0xF3,0x62,0x68,0xFD,0xAC,0x3B,0x95,0x49,0x1F,0x6B,0xB4,0x85,0xF7,0xA6,0x03,0xEC,0x6E,0x9A,0x81,0x09,0x0C,0x6A,0xEE,0x9E,0x4E,0xF0,0xAB,0x2D,0x7E,0xA1,0xE1,0xBB,0xC9,0xBC,0x41,0xF2,0xFA,0x2E,0x1B,0xDD,0x27,0x34,0xD3,0x60,0x04,0xB5,0x01,0xD6,0x40,0xF9,0xD5,0x02,0x47,0xD9,0xD8,0xE0,0x8F,0x2B,0xFB,0xB7,0xC5,0xEB,0x57,0x16,0xE5,0x78,0x8D,0xF4,0x00,0xCD,0x82,0x39,0xC6,0x96,0xBD,0xBF,0xE3,0x36,0x45,0x0E,0x26,0x1D,0x63,0xE7,0x84,0x3E,0xB6,0x9B,0x22,0xA3,0xF5,0x8E,0x23,0x6D,0xC3,0x99,0x7D,0x90,0x97,0x10,0x25,0x80,0xD4,0x4C,0xE2,0x74,0xCC,0xB2,0x5C,0x33,0xC7,0xEA,0x05,0x12,0x3F,0x51,0xA8,0xFE,0xF1,0x1C,0x42,0xCA,0xD1,0x76,0x28,0x6F,0x92,0xA7,0x67,0xA9,0x19,0xA2,0x44,0x5B,0xAA,0xEF,0x58,0x7F,0x21,0xC0,0x88,0x65,0xB9,0x5D,0x4D,0x0D,0x5A,0xC4,0x13,0x52,0x7C,0x9F,0x94,0x17,},
{0xC7,0x2B,0x82,0x61,0x5B,0xD0,0x96,0x84,0xD3,0x4A,0x70,0xA1,0x9B,0x59,0x33,0x9F,0xC0,0x20,0x14,0x53,0x29,0x17,0xC5,0x0B,0xC9,0x7B,0x97,0x02,0x0D,0x3A,0x1E,0x7C,0x3F,0x6B,0x52,0xE8,0x75,0x3D,0xF6,0xE4,0x0C,0x8A,0x4F,0xC3,0x5F,0x26,0x65,0x73,0x31,0x23,0x28,0x48,0x74,0xAA,0xA7,0x36,0x09,0xB1,0xE2,0x91,0x04,0x51,0x22,0xFC,0x08,0xA6,0x05,0xA4,0xF1,0x12,0x1C,0x19,0xEB,0x40,0x37,0xC2,0xA0,0x41,0x1D,0xD4,0xDC,0x07,0x43,0x8F,0x47,0xAF,0xD1,0x2E,0x98,0xAB,0x01,0xBA,0xF0,0x66,0x68,0xAC,0xF9,0xE7,0x69,0xB6,0xCB,0x8D,0x78,0x87,0x15,0x03,0xD5,0xDF,0xA3,0x1A,0x9D,0x6A,0xEA,0x2F,0x94,0x4E,0x9E,0x42,0xD7,0xB8,0x38,0x92,0xD8,0xBB,0xDE,0xDD,0x9A,0xBC,0xB0,0x4C,0x79,0xF4,0x58,0x3E,0xE9,0x83,0x81,0xFF,0xE3,0x55,0xFD,0x5D,0xB2,0xEF,0x9C,0x6D,0x54,0x99,0x60,0xDA,0x3B,0xEC,0xFA,0x11,0xD6,0xC4,0x2A,0xED,0x4B,0xAE,0x13,0xBF,0xB9,0x06,0x8B,0xE0,0x1F,0x7F,0x5A,0xAD,0x90,0x39,0x0F,0xF3,0xBD,0x46,0x6C,0x2C,0xF2,0xF8,0xFE,0xD9,0xE6,0x72,0x0E,0x89,0xBE,0x5E,0xC6,0xA8,0xCF,0xF5,0x57,0x7E,0x8C,0xB7,0xE1,0x88,0x7A,0xC8,0x1B,0x18,0xDB,0x6F,0x35,0xD2,0x16,0x32,0x64,0x63,0xA5,0x8E,0xF7,0xB4,0x76,0x95,0x86,0x7D,0xE5,0xA9,0x5C,0x85,0x00,0xC1,0x93,0x4D,0xFB,0x30,0xA2,0xB5,0x25,0x34,0x10,0x77,0x3C,0x67,0x71,0x2D,0x44,0x45,0x56,0x0A,0x50,0xB3,0xCD,0x62,0x80,0xCE,0x21,0x49,0x24,0xCA,0xEE,0x27,0x6E,0xCC,},
{0xA5,0xB0,0x6D,0xB2,0x51,0x55,0x1F,0xBF,0x3E,0x8D,0xDD,0x19,0x92,0xEA,0x1B,0xBD,0x32,0x65,0x29,0xA4,0x89,0x67,0xB1,0x90,0x68,0x00,0xDA,0x0D,0xA6,0x59,0x54,0xF2,0x10,0x14,0x2F,0x45,0xE0,0x3B,0x23,0xFA,0xD7,0x50,0xAC,0x93,0xE6,0x43,0x01,0x0A,0x5C,0x78,0x70,0x98,0x46,0xA9,0x7B,0xF3,0x95,0x07,0x2A,0xD3,0x74,0xB3,0x3F,0xA3,0x60,0x82,0x39,0x4E,0x34,0x48,0xC0,0x1C,0xF6,0xC2,0x91,0x64,0x4D,0x3C,0xF8,0x9D,0x35,0x9A,0x94,0xE3,0x7A,0xF0,0xF9,0x6E,0xB9,0x12,0xB8,0x04,0x2D,0x02,0x28,0x13,0x85,0x72,0x80,0x87,0xDB,0x2B,0xF1,0x4F,0x26,0xA2,0xE1,0x49,0x7E,0x9C,0xCC,0xA7,0xB6,0xA0,0xD0,0x9B,0x36,0x77,0xAD,0x8B,0x6B,0x4A,0x03,0x1D,0x05,0x8A,0x06,0x4B,0xAF,0xE5,0x31,0xB5,0xD4,0xC6,0x0C,0x66,0xBA,0x83,0xFD,0x09,0x0F,0xAE,0x71,0xB7,0x6F,0xDC,0x41,0xE8,0x17,0x8E,0x40,0x7F,0x62,0x30,0xFF,0xA8,0x84,0x25,0xFB,0x16,0xCE,0x37,0x44,0xAB,0x99,0x1E,0xEB,0x18,0x3A,0x47,0xF7,0x5F,0x81,0xCF,0xED,0x58,0x2C,0x6C,0xFE,0x9E,0x57,0x53,0x97,0x20,0xCA,0x79,0x1A,0x5A,0x88,0xF5,0x69,0x9F,0xE7,0xD9,0x0E,0xBE,0x42,0xDF,0x56,0xE4,0x4C,0x22,0xAA,0x73,0x0B,0x15,0xC5,0xEE,0xFC,0xC7,0xD6,0xCB,0xCD,0x8C,0xE2,0x76,0x21,0xE9,0xD1,0xEC,0xC8,0x7D,0xD8,0x8F,0x61,0x7C,0x2E,0xBC,0xDE,0xB4,0x75,0xD2,0xC4,0x63,0x3D,0xA1,0x5E,0x5D,0x6A,0x08,0x24,0xC9,0x27,0xBB,0xEF,0x33,0x86,0x5B,0xD5,0x38,0x52,0x11,0xF4,0xC3,0x96,0xC1,},
{0x34,0x5A,0xDB,0x2C,0x59,0x57,0x12,0x2B,0x30,0xC2,0xA0,0x92,0xBF,0xED,0xBC,0x45,0xDE,0x27,0x9B,0x96,0xD3,0xE6,0xC5,0xEB,0xD8,0x24,0x4B,0xA4,0x21,0xCC,0xA8,0xD6,0xCE,0x3C,0xBA,0xB1,0x09,0xE0,0xD7,0x32,0x66,0x4A,0x83,0x1D,0x19,0xCA,0x89,0x67,0x0F,0x42,0x07,0x71,0xE9,0xBB,0x44,0x5E,0x85,0x17,0xC4,0xAE,0x9C,0x3F,0x6B,0x78,0xE7,0x6D,0x02,0xA7,0xFE,0x33,0xE3,0xD9,0x0A,0x7D,0xEA,0xF1,0x18,0x87,0x7B,0x62,0x03,0x79,0x52,0x23,0x00,0x3E,0x25,0xB9,0xDD,0x16,0x68,0x3B,0x1F,0x90,0xA6,0x2A,0xC6,0x29,0x91,0x8A,0x9D,0xEF,0x1E,0x84,0x76,0xEE,0x4F,0x39,0xFB,0x11,0x1B,0x0B,0x93,0xAD,0x49,0xB7,0x05,0xE1,0x4D,0xCB,0xE8,0x38,0xD0,0x55,0xF2,0xF7,0x0D,0x8B,0x65,0xCD,0xFA,0xD4,0x9E,0xC9,0x81,0x4E,0x14,0xC8,0x26,0xB6,0xF9,0xAA,0xF5,0x80,0xF8,0x6A,0x98,0xAB,0x58,0xF3,0xB8,0x8E,0xB5,0x97,0x43,0x72,0xA2,0xDA,0x64,0xC1,0x40,0x5C,0x13,0xB0,0xE5,0xBD,0x08,0x9F,0x1C,0x7E,0x8F,0x06,0xBE,0x6E,0x50,0x1A,0x2F,0x37,0xA1,0xFC,0x10,0x2E,0x70,0x53,0x04,0x20,0x63,0x48,0xE2,0xFD,0x6F,0x7A,0x75,0x61,0xB3,0x35,0x3A,0xCF,0x5B,0x88,0x82,0x51,0xD2,0x47,0xA5,0xA9,0x74,0x6C,0x31,0x94,0x7C,0x9A,0xC0,0xEC,0x15,0x0E,0x28,0x01,0x2D,0xC3,0xF0,0xB4,0xE4,0x8D,0xDC,0xAC,0x3D,0x5F,0x86,0xC7,0x95,0x22,0xF4,0xB2,0xA3,0x54,0x46,0xD1,0x77,0x8C,0x0C,0xFF,0xAF,0x56,0x5D,0x36,0x69,0x7F,0x99,0x4C,0xD5,0x60,0x73,0xDF,0x41,0xF6,},
{0x04,0xDA,0x79,0x63,0x1E,0xBD,0xEA,0xE3,0x0B,0x65,0x25,0x01,0xCD,0xA9,0x92,0xED,0x18,0x75,0x57,0x30,0x89,0x03,0x09,0x6A,0xDC,0xC7,0x98,0xA4,0x50,0x91,0x1F,0xB1,0x0C,0x77,0x85,0x66,0xCA,0x12,0x1C,0x67,0xC2,0xE0,0x17,0x83,0x59,0x9D,0xD5,0x22,0x82,0x56,0xA8,0x9F,0xC6,0x60,0x48,0xB3,0x11,0xFC,0xA3,0x28,0xFB,0x06,0xDD,0x5D,0xBA,0x29,0x7A,0x4F,0xE8,0xFE,0xE9,0x10,0xCB,0xF3,0x93,0x7B,0x6C,0x69,0x54,0xE7,0x44,0xA2,0x84,0x1D,0x8D,0xCE,0xFF,0xFA,0x1A,0x87,0x90,0x74,0xA1,0xF8,0x14,0xAA,0xBC,0xC0,0xCF,0x31,0xB4,0xD9,0xBF,0xD8,0x5E,0x26,0x2D,0xD0,0xE4,0x3F,0x19,0xD6,0x8C,0x2F,0xAB,0x39,0x58,0x72,0x6E,0xDF,0x3B,0xE6,0x3C,0xB6,0x62,0x88,0xDE,0x40,0xB2,0x8F,0x9B,0x7C,0x95,0x43,0xD1,0x9E,0xAC,0x9C,0xD4,0x23,0xE1,0x0E,0x4B,0x53,0x33,0x46,0x20,0x13,0x34,0x1B,0x97,0xF7,0xF1,0xC3,0x61,0x4A,0x6F,0x5A,0x21,0x7F,0x70,0x2E,0x55,0x41,0x05,0xC5,0xD7,0x76,0xE5,0x27,0x15,0xEC,0x42,0x5C,0x4D,0x78,0x35,0x8B,0xEF,0xD2,0xEE,0xB5,0xBE,0xAE,0x02,0x3A,0xD3,0x5F,0xC4,0x24,0xF0,0xF9,0x51,0x4E,0xEB,0x00,0x0F,0xFD,0xAF,0x3E,0xC1,0x9A,0x52,0x86,0x81,0x80,0x7E,0xF6,0x2B,0xCC,0xB9,0x7D,0x68,0xF2,0xAD,0x99,0xA7,0x07,0x2C,0x73,0x38,0xB0,0x6B,0xB7,0x8E,0x71,0xA0,0xF4,0x3D,0xA6,0x0D,0x37,0xDB,0x0A,0x47,0x36,0x16,0x96,0x6D,0x32,0x2A,0x5B,0xE2,0x45,0x94,0xF5,0xA5,0x4C,0xC8,0x8A,0x49,0x64,0xBB,0x08,0xC9,0xB8,},
};

void ascii_to_accesscode(uint8_t *ascii_data ,uint8_t *accesscode){
	accesscode[0] = 0x00;
	accesscode[1] = 0x00;
	for(uint8_t i = 0;i<8;i++){
		accesscode[i + 2] = (ascii_data[2 * i] - 0x30) << 4 | (ascii_data[2 * i + 1] - 0x30);
	}
}

void hex_to_accesscode(uint8_t *hex ,uint8_t *accesscode){
	accesscode[0] = 0x00;
	accesscode[1] = 0x00;
	memcpy(accesscode + 2, hex, 8);
	for(uint8_t i = 0;i<8;i++){
		uint8_t tmp_high = (hex[i] >> 4);
		uint8_t tmp_low = (hex[i] & 0b1111);
		if(tmp_high >= 10){
			tmp_high -= 7;
		}
		if(tmp_low >= 10){
			tmp_low -= 7;
		}
		accesscode[i+2] = tmp_high << 4 | tmp_low;
	}
}

void DECRYPT_ACCESSCODE(uint8_t *ACCESS_CODE)
{
    for (uint8_t i = 0; i < 16; i++)
    {
        ACCESS_CODE[i] = S_BOX_INV[N_TABLES][ACCESS_CODE[i]];
    }
    uint8_t count = (ACCESS_CODE[15] >> 4) + 7;
    uint8_t table = ACCESS_CODE[15] + ITER_ADD * count;
    for (uint8_t iter = 0; iter < count; iter++)
    {
        table -= ITER_ADD;
        {
            uint8_t prior = ACCESS_CODE[14];  // 第15个字节是 result[14]
            for (uint8_t i = 0; i < 15; i++)
            {
                uint8_t temp = ACCESS_CODE[i];
                ACCESS_CODE[i] = (ACCESS_CODE[i] >> 5) | ((prior & 0x1F) << 3);
                prior = temp;
            }
        }
        for (uint8_t i = 0; i < 15; i++)
        {
            ACCESS_CODE[i] = S_BOX_INV[table % N_TABLES][ACCESS_CODE[i]];
        }
    }
}
